name: Deploy via SSH (No Docker)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          command_timeout: 30m
          script: |
            cd ~/apps/carbonos
            
            echo "=== Step 1: Update Code ==="
            git fetch origin main
            git reset --hard origin/main
            
            echo "=== Step 2: Check/Install Python 3.11 ==="
            if ! command -v python3.11 &> /dev/null; then
                echo "Installing Python 3.11..."
                sudo apt update
                sudo apt install -y python3.11 python3.11-venv python3.11-dev
            fi
            python3.11 --version
            
            echo "=== Step 3: Check/Install Node.js 20 ==="
            if ! command -v node &> /dev/null || [[ $(node -v | cut -d. -f1 | tr -d 'v') -lt 20 ]]; then
                echo "Installing Node.js 20..."
                curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
                sudo apt install -y nodejs
            fi
            node --version
            npm --version
            
            echo "=== Step 4: Check/Install PM2 ==="
            if ! command -v pm2 &> /dev/null; then
                echo "Installing PM2..."
                sudo npm install -g pm2
            fi
            pm2 --version
            
            echo "=== Step 5: Setup Backend ==="
            cd ~/apps/carbonos/carbonos/backend
            
            # 创建虚拟环境（如果不存在）
            if [ ! -d "venv" ]; then
                python3.11 -m venv venv
            fi
            
            # 激活虚拟环境并安装依赖
            source venv/bin/activate
            pip install --upgrade pip
            pip install -e .
            
            # 创建 .env 文件（如果不存在）
            if [ ! -f .env ]; then
                echo "SECRET_KEY=$(openssl rand -hex 32)" > .env
                echo "DATABASE_URL=postgresql+asyncpg://carbonos:carbonos@localhost:5432/carbonos" >> .env
                echo "REDIS_URL=redis://localhost:6379/0" >> .env
            fi
            
            echo "=== Step 6: Setup Frontend ==="
            cd ~/apps/carbonos/carbonos
            npm install
            npm run build
            
            echo "=== Step 7: Start/Restart Database Services ==="
            cd ~/apps/carbonos
            # 只启动数据库相关的 Docker 容器
            sudo docker compose -f docker-compose.db.yml up -d
            sleep 5
            
            echo "=== Step 8: Run Migrations ==="
            cd ~/apps/carbonos/carbonos/backend
            source venv/bin/activate
            alembic upgrade head || echo "Migration failed or skipped"
            
            echo "=== Step 9: Start/Restart App with PM2 ==="
            cd ~/apps/carbonos
            pm2 start ecosystem.config.js --update-env || pm2 restart all
            pm2 save
            
            echo "=== Step 10: Reload Nginx ==="
            sudo cp nginx/nginx-ssh.conf /etc/nginx/sites-available/carbonos
            sudo ln -sf /etc/nginx/sites-available/carbonos /etc/nginx/sites-enabled/
            sudo nginx -t && sudo systemctl reload nginx
            
            echo "=== Step 11: Health Check ==="
            sleep 5
            curl -s http://localhost:8000/health || echo "Backend health check failed"
            curl -s http://localhost:3000 | head -c 100 || echo "Frontend check failed"
            
            echo "=== Deployment Complete ==="
            pm2 status
