name: Deploy via SSH (No Docker)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          command_timeout: 30m
          script: |
            echo "=== Step 0: Prepare Directory ==="
            mkdir -p ~/apps
            cd ~/apps
            
            # Clone or update repository (use shallow clone for speed)
            if [ ! -d "carbonos/.git" ]; then
                echo "Cloning repository (shallow)..."
                rm -rf carbonos
                git clone --depth 1 https://github.com/${{ github.repository }}.git carbonos
            fi
            cd carbonos
            
            echo "=== Step 1: Update Code ==="
            git fetch --depth 1 origin main
            git reset --hard origin/main
            
            echo "=== Step 2: Check/Install Python 3.11 ==="
            if ! command -v python3.11 &> /dev/null; then
                echo "Installing Python 3.11 via deadsnakes PPA..."
                sudo add-apt-repository -y ppa:deadsnakes/ppa
                sudo apt update
                sudo apt install -y python3.11 python3.11-venv python3.11-dev
            fi
            python3.11 --version
            
            echo "=== Step 3: Check/Install Node.js 20 ==="
            if ! command -v node &> /dev/null || [[ $(node -v | cut -d. -f1 | tr -d 'v') -lt 20 ]]; then
                echo "Installing Node.js 20..."
                curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
                sudo apt install -y nodejs
            fi
            node --version
            npm --version
            
            echo "=== Step 4: Check/Install PM2 ==="
            if ! command -v pm2 &> /dev/null; then
                echo "Installing PM2..."
                sudo npm install -g pm2
            fi
            pm2 --version
            
            echo "=== Step 5: Check/Install Nginx ==="
            if ! command -v nginx &> /dev/null; then
                echo "Installing Nginx..."
                sudo apt install -y nginx
            fi
            nginx -v
            
            echo "=== Step 6: Setup Backend ==="
            cd ~/apps/carbonos/carbonos/backend
            
            # 创建虚拟环境（如果不存在）
            if [ ! -d "venv" ]; then
                python3.11 -m venv venv
            fi
            
            # 激活虚拟环境并安装依赖
            source venv/bin/activate
            pip install --upgrade pip
            pip install -e .
            
            # 创建 .env 文件（如果不存在）
            if [ ! -f .env ]; then
                echo "SECRET_KEY=$(openssl rand -hex 32)" > .env
                echo "DATABASE_URL=postgresql+asyncpg://carbonos:carbonos@localhost:5432/carbonos" >> .env
                echo "REDIS_URL=redis://localhost:6379/0" >> .env
            fi
            cat .env | head -c 50
            echo "..."
            
            echo "=== Step 7: Setup Frontend ==="
            cd ~/apps/carbonos/carbonos
            npm install
            npm run build
            
            echo "=== Step 8: Stop Orphan Docker Containers ==="
            cd ~/apps/carbonos
            # 停止可能占用端口80的旧容器
            sudo docker compose -f docker-compose.prod.yml down --remove-orphans 2>/dev/null || true
            sudo docker stop carbonos-nginx-1 carbonos-frontend-1 carbonos-backend-1 2>/dev/null || true
            sudo docker rm carbonos-nginx-1 carbonos-frontend-1 carbonos-backend-1 2>/dev/null || true
            
            echo "=== Step 9: Start Database Services Only ==="
            # 只启动数据库相关的 Docker 容器
            sudo docker compose -f docker-compose.db.yml up -d --remove-orphans
            sleep 5
            
            echo "=== Step 10: Run Migrations ==="
            cd ~/apps/carbonos/carbonos/backend
            source venv/bin/activate
            # 运行迁移
            alembic upgrade head || {
                echo "Migration failed, stamping..."
                alembic stamp head 2>/dev/null || true
            }
            
            # 无论迁移是否成功，都确保所有必需列存在（幂等操作）
            echo "=== Step 10b: Ensure Required Columns Exist ==="
            sudo docker exec carbonos-postgres-1 psql -U carbonos -d carbonos -c "
                DO \$\$ BEGIN
                    -- is_superuser 列
                    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'users' AND column_name = 'is_superuser') THEN
                        ALTER TABLE users ADD COLUMN is_superuser BOOLEAN NOT NULL DEFAULT false;
                        CREATE INDEX ix_users_is_superuser ON users(is_superuser);
                        RAISE NOTICE 'Added is_superuser column';
                    END IF;
                    -- last_login_at 列
                    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'users' AND column_name = 'last_login_at') THEN
                        ALTER TABLE users ADD COLUMN last_login_at TIMESTAMP;
                        RAISE NOTICE 'Added last_login_at column';
                    END IF;
                    -- failed_login_attempts 列
                    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'users' AND column_name = 'failed_login_attempts') THEN
                        ALTER TABLE users ADD COLUMN failed_login_attempts INTEGER NOT NULL DEFAULT 0;
                        RAISE NOTICE 'Added failed_login_attempts column';
                    END IF;
                    -- locked_until 列
                    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'users' AND column_name = 'locked_until') THEN
                        ALTER TABLE users ADD COLUMN locked_until TIMESTAMP;
                        RAISE NOTICE 'Added locked_until column';
                    END IF;
                END \$\$;
            "
            echo "Required columns verified"
            
            echo "=== Step 11: Create logs directory ==="
            mkdir -p ~/apps/carbonos/logs
            mkdir -p ~/apps/carbonos/carbonos/backend/logs
            
            echo "=== Step 12: Start/Restart App with PM2 ==="
            cd ~/apps/carbonos
            pm2 delete all 2>/dev/null || true
            pm2 start ecosystem.config.js
            pm2 save
            
            echo "=== Step 13: Start Nginx ==="
            sudo cp nginx/nginx-ssh.conf /etc/nginx/sites-available/carbonos
            sudo ln -sf /etc/nginx/sites-available/carbonos /etc/nginx/sites-enabled/carbonos
            sudo rm -f /etc/nginx/sites-enabled/default
            # 确保 nginx 能正常启动
            sudo fuser -k 80/tcp 2>/dev/null || true
            sudo nginx -t && (sudo systemctl start nginx 2>/dev/null || sudo systemctl reload nginx)
            
            echo "=== Step 14: Health Check ==="
            sleep 5
            curl -s http://localhost:8000/health || echo "Backend health check failed"
            curl -s http://localhost:3000 | head -c 100 || echo "Frontend check failed"
            
            echo "=== Deployment Complete ==="
            pm2 status
